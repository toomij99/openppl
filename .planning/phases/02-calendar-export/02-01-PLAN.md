---
phase: 02-calendar-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/services/export_ics.go
  - internal/services/export_ics_test.go
autonomous: true
requirements:
  - ICAL-01
  - ICAL-02
  - ICAL-03
user_setup: []

must_haves:
  truths:
    - "User can run ICS export and get a non-empty .ics file path"
    - "Generated .ics file has RFC5545 VCALENDAR/VEVENT structure with required fields"
    - "Exported event timestamps are UTC and import-safe for Google Calendar"
  artifacts:
    - path: "internal/services/export_ics.go"
      provides: "ICS exporter service that serializes study tasks into VEVENT records"
      exports: ["ExportICS"]
    - path: "internal/services/export_ics_test.go"
      provides: "Automated coverage for ICS envelope, UTC formatting, and deterministic UID behavior"
  key_links:
    - from: "internal/services/export_ics.go"
      to: "github.com/arran4/golang-ical"
      via: "calendar/event serializer API"
      pattern: "ics\\.NewCalendar|AddEvent|Set(StartAt|EndAt|DtStampTime)"
    - from: "internal/services/export_ics.go"
      to: "filesystem"
      via: "os.WriteFile"
      pattern: "os\\.WriteFile"
---

<objective>
Build a dedicated ICS export service that converts persisted study tasks into a valid .ics calendar file using the standard library-backed approach from research.

Purpose: Deliver Phase 2 calendar compatibility outcomes quickly with low format-risk while reusing existing project data and existing local ICS generation approach.
Output: `ExportICS` service + automated tests validating envelope, UTC timestamps, and deterministic event identity.
</objective>

<execution_context>
@/Users/tommy/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/tommy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-export/02-RESEARCH.md
@internal/model/model.go
@internal/services/planner.go
@icss/Flight_Study_2025-12-08.ics
</context>

<tasks>

<task type="auto">
  <name>Implement ICS exporter service with UTC-normalized events</name>
  <files>go.mod, go.sum, internal/services/export_ics.go</files>
  <action>
    Add `github.com/arran4/golang-ical@v0.3.3` and implement `ExportICS` in `internal/services/export_ics.go`.
    Use existing `model.DailyTask` records as source input; do not add new DB schema.
    Create one `VCALENDAR` with `PRODID`/`VERSION` and one `VEVENT` per task with deterministic UID (stable per task identity), `DTSTAMP`, `DTSTART`, `DTEND`, summary, and description.
    Normalize event times to UTC with `Z` suffix for Google import behavior (`ICAL-03`) and keep output Apple Calendar compatible (`ICAL-02`).
    Write to disk under an export path (for example `exports/study-plan-YYYYMMDD.ics`) and return path + count + error metadata.
    Reuse structural ideas from existing files under `icss/` where sensible; do not hand-roll RFC text assembly.
  </action>
  <verify>
    <automated>go mod tidy && go test ./... && go build ./...</automated>
    <manual>Open generated .ics and confirm it contains VCALENDAR, at least one VEVENT, UID, DTSTAMP, DTSTART, and SUMMARY lines.</manual>
  </verify>
  <done>Service exports a valid, non-empty .ics file from task input and returns export metadata without panics.</done>
</task>

<task type="auto">
  <name>Add ICS compatibility and formatting tests</name>
  <files>internal/services/export_ics_test.go</files>
  <action>
    Add focused tests that create representative `DailyTask` fixtures and assert serialized output includes required RFC markers and UTC-style datetime fields.
    Cover deterministic UID generation (same task identity yields same UID), non-empty calendar envelope, and expected event count.
    Keep tests hermetic by writing to a temporary directory and cleaning up files in test lifecycle.
  </action>
  <verify>
    <automated>go test ./internal/services -run TestICS -v</automated>
  </verify>
  <done>Tests fail when required calendar structure or UTC formatting regresses and pass for the implemented exporter.</done>
</task>

</tasks>

<verification>
- `go test ./internal/services -run TestICS -v` passes
- `go test ./...` and `go build ./...` pass
- Generated `.ics` file is non-empty and contains VEVENT data for exported tasks
</verification>

<success_criteria>
- [ ] `ICAL-01`: ICS export produces a file from study plan tasks
- [ ] `ICAL-02`: Export output contains required Apple-compatible ICS structure
- [ ] `ICAL-03`: Export output uses UTC datetime semantics suitable for Google import
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-export/02-01-SUMMARY.md`
</output>
