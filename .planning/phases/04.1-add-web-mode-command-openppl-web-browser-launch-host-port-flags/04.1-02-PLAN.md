---
phase: 04.1-web-mode-command
plan: 02
type: execute
wave: 2
depends_on:
  - 04.1-web-mode-command-01
files_modified:
  - internal/web/server.go
  - internal/web/browser.go
  - internal/web/browser_test.go
autonomous: true
requirements:
  - WEB-01
  - WEB-02
user_setup: []

must_haves:
  truths:
    - "When web mode starts, user gets a browser-open attempt to a reachable URL"
    - "Wildcard bind hosts (`0.0.0.0`, `::`) map to `localhost` for browser opening"
    - "Web server start logs include bind details for troubleshooting"
  artifacts:
    - path: "internal/web/server.go"
      provides: "web runtime startup with browser launch attempt and startup diagnostics"
    - path: "internal/web/browser.go"
      provides: "host normalization and cross-platform browser open command routing"
    - path: "internal/web/browser_test.go"
      provides: "stable browser URL mapping tests"
  key_links:
    - from: "internal/web/server.go"
      to: "internal/web/browser.go"
      via: "browserURL/openBrowser usage"
      pattern: "browserURL|openBrowser"
    - from: "main.go"
      to: "internal/web/server.go"
      via: "runWeb command handoff"
      pattern: "web\.Run"
---

<objective>
Harden the web runtime launch path so browser opening and startup diagnostics are predictable across host bindings.

Purpose: Ensure users launching `openppl web` can consistently access the UI and diagnose startup behavior.
Output: web server/browser normalization updates and tests in `internal/web`.
</objective>

<execution_context>
@/Users/tommy/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/tommy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04.1-add-web-mode-command-openppl-web-browser-launch-host-port-flags/04.1-RESEARCH.md
@.planning/phases/04.1-add-web-mode-command-openppl-web-browser-launch-host-port-flags/04.1-01-SUMMARY.md
@internal/web/server.go
@internal/web/browser.go
</context>

<tasks>

<task type="auto">
  <name>Harden browser URL host normalization for web-mode launch</name>
  <files>internal/web/browser.go, internal/web/browser_test.go</files>
  <action>
    Ensure browser URL generation consistently maps wildcard bind hosts (`0.0.0.0`, `::`, `[::]`) to `localhost` while preserving explicit hostnames/IPs.
    Add tests for IPv4 wildcard, IPv6 wildcard, and explicit host pass-through behavior.
  </action>
  <verify>
    <automated>go test ./internal/web -run TestBrowserURLLocalhostMapping -count=1</automated>
  </verify>
  <done>Browser URL normalization is deterministic and fully covered for wildcard and explicit host cases.</done>
</task>

<task type="auto">
  <name>Align web startup logs and browser-open flow with command expectations</name>
  <files>internal/web/server.go</files>
  <action>
    Keep startup output explicit about bind address and browser target URL, and retain non-fatal browser-open failure logging.
    Ensure server startup remains blocking on `ListenAndServe` and does not crash on browser-open errors.
  </action>
  <verify>
    <automated>go test ./internal/web -count=1</automated>
  </verify>
  <done>Web startup is diagnosable, and browser-open issues do not prevent serving the web UI.</done>
</task>

<task type="auto">
  <name>Run regression checks for full web-mode command path</name>
  <files>main.go, internal/web/server.go, internal/web/browser.go</files>
  <action>
    Execute focused package tests and then full repo tests to ensure web-mode changes do not regress TUI or service behavior.
  </action>
  <verify>
    <automated>go test ./internal/web -count=1 && go test . -run TestRunWeb -count=1 && go test ./... </automated>
  </verify>
  <done>Web-mode behavior is stable and cross-package regression checks pass.</done>
</task>

</tasks>

<verification>
- `go test ./internal/web -count=1` passes
- `go test . -run TestRunWeb -count=1` passes
- `go test ./...` passes
</verification>

<success_criteria>
- [ ] Browser launch URL is normalized safely for wildcard bind hosts
- [ ] Web startup logs are actionable and browser-open failures remain non-fatal
- [ ] End-to-end command and package regression checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-add-web-mode-command-openppl-web-browser-launch-host-port-flags/04.1-02-SUMMARY.md`
</output>
