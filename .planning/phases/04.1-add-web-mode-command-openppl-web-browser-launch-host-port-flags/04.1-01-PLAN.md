---
phase: 04.1-web-mode-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.go
  - main_web_test.go
autonomous: true
requirements:
  - WEB-01
  - WEB-02
  - WEB-03
user_setup: []

must_haves:
  truths:
    - "User can run `openppl web` and the command starts web mode instead of TUI mode"
    - "Invalid `--hostname`/`--port` values are rejected with deterministic non-zero CLI errors"
    - "Web mode still respects setup/onboarding preconditions before server startup"
  artifacts:
    - path: "main.go"
      provides: "top-level `web` command routing and validated host/port parsing"
    - path: "main_web_test.go"
      provides: "CLI contract tests for web command arguments and failure modes"
  key_links:
    - from: "main.go"
      to: "internal/web/server.go"
      via: "runWeb() delegates to web.Run"
      pattern: "web\.Run"
    - from: "main.go"
      to: "internal/db/db.go"
      via: "web command setup/database initialization"
      pattern: "db\.Initialize"
---

<objective>
Establish a reliable command boundary for `openppl web` with explicit host/port parsing and onboarding-safe startup behavior.

Purpose: Ensure web-mode launch is deterministic and safe from malformed CLI inputs.
Output: validated web command path in `main.go` and test coverage in `main_web_test.go`.
</objective>

<execution_context>
@/Users/tommy/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/tommy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04.1-add-web-mode-command-openppl-web-browser-launch-host-port-flags/04.1-RESEARCH.md
@main.go
</context>

<tasks>

<task type="auto">
  <name>Add/confirm top-level web command routing with strict flag validation</name>
  <files>main.go</files>
  <action>
    Implement or harden `runWeb(args)` so `openppl web` accepts `--hostname` and `--port`, rejects empty hostname and out-of-range ports, and returns explicit wrapped errors.
    Keep existing command routing behavior for `onboard`, `logs`, and `help` unchanged.
    Do not move server startup logic into `run()`; keep web-mode handling isolated in `runWeb`.
  </action>
  <verify>
    <automated>go test . -run TestRunWeb -count=1</automated>
  </verify>
  <done>Web command path validates CLI inputs and returns deterministic non-zero failures for invalid flags.</done>
</task>

<task type="auto">
  <name>Add command-contract tests for web-mode CLI behavior</name>
  <files>main_web_test.go</files>
  <action>
    Add tests for default web args, valid custom host/port, invalid empty hostname, invalid low/high port values, and unknown web flags.
    Use test seams/mocks where needed to avoid launching real browser/server during tests.
    Keep test execution under 60 seconds and focused on command boundary behavior.
  </action>
  <verify>
    <automated>go test . -run TestRunWeb -count=1</automated>
  </verify>
  <done>Command-level tests lock web CLI argument and validation behavior without invoking external side effects.</done>
</task>

<task type="auto">
  <name>Verify onboarding gating remains intact for web mode</name>
  <files>main.go, main_web_test.go</files>
  <action>
    Ensure `runWeb` continues to call setup checks before starting web server and surfaces setup errors consistently.
    Add or update tests that assert onboarding precheck executes for web-mode launches.
  </action>
  <verify>
    <automated>go test . -run 'TestRunWeb|TestNeedsSetup' -count=1</automated>
  </verify>
  <done>Web mode preserves setup/onboarding preconditions and does not bypass first-run safety checks.</done>
</task>

</tasks>

<verification>
- `go test . -run 'TestRunWeb|TestNeedsSetup' -count=1` passes
- `go test ./internal/web -run TestBrowserURLLocalhostMapping -count=1` passes
- `go test ./...` passes
</verification>

<success_criteria>
- [ ] `openppl web` is routable from main command entrypoint without breaking existing commands
- [ ] Invalid host/port flags produce deterministic validation errors
- [ ] Web launch path still enforces onboarding/setup checks
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-add-web-mode-command-openppl-web-browser-launch-host-port-flags/04.1-01-SUMMARY.md`
</output>
